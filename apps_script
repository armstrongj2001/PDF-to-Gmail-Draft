function onOpen() {
  var ui = SpreadsheetApp.getUi();
  var menu = ui.createMenu('Custom PDF Add-on');
  menu.addItem('Create email draft with PDF', 'createEmailDraftWithPdf');
  menu.addItem('Create download link for PDF', 'createDownloadLink');
  menu.addToUi();
}


function createDownloadLink() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet();
  var sheetId = sheet.getId();
  var activeSheet = sheet.getActiveSheet();

  var pdfOptions = {
    'sheetId': sheetId,
    'sheetName': activeSheet.getName(),
    'scale': '1'
  };

  var url = 'https://docs.google.com/spreadsheets/d/' + pdfOptions.sheetId + '/export?';
  var exportOptions =
    'exportFormat=pdf&format=pdf' +
    '&size=letter' +
    '&portrait=true' +
    '&fitw=true' +
    '&sheetnames=false&printtitle=false' +
    '&pagenumbers=false&gridlines=false' +
    '&fzr=false' +
    '&gid=' + activeSheet.getSheetId();

  url += exportOptions;

  var htmlOutput = HtmlService.createHtmlOutput('<a href="' + url + '" download="' + sheet.getName() + ' - ' + activeSheet.getName() + '.pdf" target="_blank">Download PDF</a>')
    .setWidth(200)
    .setHeight(100);
    
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'Download PDF');
}

function createEmailDraftWithPdf() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet();
  var sheetId = sheet.getId();
  var activeSheet = sheet.getActiveSheet();

  var pdfOptions = {
    'sheetId': sheetId,
    'sheetName': activeSheet.getName(),
    'scale': '1' // Fit to width
  };

  var url = 'https://docs.google.com/spreadsheets/d/' + pdfOptions.sheetId + '/export?';
  var exportOptions =
    'exportFormat=pdf&format=pdf' +
    '&size=letter' +
    '&portrait=true' +
    '&fitw=true' +
    '&sheetnames=false&printtitle=false' +
    '&pagenumbers=false&gridlines=false' +
    '&fzr=false' +
    '&gid=' + activeSheet.getSheetId();

  url += exportOptions;

  var token = ScriptApp.getOAuthToken();
  var response = UrlFetchApp.fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });

  var pdfBlob = response.getBlob().setName(sheet.getName() + ' - ' + activeSheet.getName() + '.pdf');
  var emailSubject = sheet.getName() + ' - ' + activeSheet.getName() + '.pdf'; // Set the email subject to the title of the PDF file

   var emailBody = "Good evening,\n\nIt was great meeting you today and Thank you for the opportunity to earn your business.\n\nAttached is the estimate for the full scope of work that we discussed, including all materials.\n\nPlease let me know if you have any questions or if any revisions need to be made, I am available to take a call if needed.\n\nWe do have a crew available to start this project at your approval, we are looking forward to helping you with this project.\nThank you!";
  
  var emailAddress = activeSheet.getRange('G6').getValue(); // Get the email address from cell G6

  if (emailAddress) {
    // Create a draft email instead of sending it directly
    GmailApp.createDraft(emailAddress, emailSubject, emailBody, {attachments: [pdfBlob]});
    SpreadsheetApp.getUi().alert('A draft email with the attached PDF has been created for ' + emailAddress + '.');
  } else {
    SpreadsheetApp.getUi().alert('No email address found in cell G6. Draft creation canceled.');
  }
}
